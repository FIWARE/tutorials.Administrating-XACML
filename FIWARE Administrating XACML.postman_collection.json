{
	"info": {
		"_postman_id": "59ce8a5e-c01f-4d7b-964e-64dd67f2fce5",
		"name": "FIWARE Administrating XACML",
		"description": "[![FIWARE Security](https://nexus.lab.fiware.org/repository/raw/public/badges/chapters/security.svg)](https://www.fiware.org/developers/catalogue/)\n\nThis tutorial introduces the administration of level 3 advanced authorization rules into **Keyrock**. The simple verb-resource based permissions are amended to use XACML and new XACML permissions added to the existing roles. The updated ruleset is automatically uploaded to **Authzforce** PDP, so that policy execution points such as the **PEP proxy** are able to apply the latest ruleset.\n\nThe tutorial demonstrates examples of interactions using the **Keyrock** GUI, as\nwell [cUrl](https://ec.haxx.se/) commands used to access the REST\nAPIs of **Keyrock**  and **Authzforce** \n\nThe `docker-compose` files for this tutorial can be found on GitHub: \n\n![GitHub](https://fiware.github.io/tutorials.Administrating-XACML/icon/GitHub-Mark-32px.png) [FIWARE 406: Administrating XACML](https://github.com/Fiware/tutorials.Administrating-XACML)\n\n# Administrating XACML Rules\n\n> **12.3 Central Terminal Area**\n>\n> * Red or Yellow Zone\n>    * No private vehicle shall stop, wait, or park in the red or yellow zone.\n> * White Zone\n>    * No vehicle shall stop, wait, or park in the white zone unless actively\n> engaged in the immediate loading or unloading of passengers\n> and/or baggage.\n>\n> — Los Angeles International Airport Rules and Regulations, Section 12 - Landside Motor Vehicle Operations\n\nBusiness rules change over time, and it is necessary to be able to amend access controls accordingly. The [previous tutorial](https://github.com/Fiware/tutorials.XACML-Access-Rules) included a static XACML `<PolicySet>` loaded into **Authzforce**. This component offers advanced authorization (level 3) access control where every policy decision is calculated on the fly and new rules can be applied under new circumstances.\nThe details of the [Authzforce](https://authzforce-ce-fiware.readthedocs.io/) Policy Decision Point (PDP) were discussed in the [previous tutorial](https://github.com/Fiware/tutorials.XACML-Access-Rules), suffice to say, the **Authzforce** PDP interprets rules according to the\n[XACML standard](https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=xacml) and offers a means to adjudicate on any access request provided that sufficient information can be supplied.\n\nFor full flexibility, it must be possible to load, update and activate a new access control XACML `<PolicySet>` whenever necessary. In order to do, this **Authzforce** offers a simple REST Policy Adminstration Point (PAP), an alternative role-based PAP is available within **Keyrock**\n\n## What is XACML\n\neXtensible Access Control Markup Language (XACML) is a vendor neutral\ndeclarative access control policy language. It was created to promote common\naccess control terminology and interoperability. The architectural naming\nconventions for elements such as Policy Execution Point (PEP) and Policy\nDecision Point (PDP) come from the XACML specifications.\n\nXACML policies are split into a hierarchy of three levels - `<PolicySet>`,\n`<Policy>` and `<Rule>`, the `<PolicySet>` is a collection of `<Policy>`\nelements each of which contain one or more `<Rule>` elements.\n\nEach `<Rule>` within a `<Policy>` is evaluated as to whether it should grant\naccess to a resource - the overall `<Policy>` result is defined by the overall\nresult of all `<Rule>` elements processed in turn. Separate `<Policy>` results\nare then evaluated against each other using combining alogorthms define which\n`<Policy>` wins in case of conflict.\n\nFurther information can be found within the [XACML standard](https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=xacml)\n\n## PAP - Policy Administration Point\n\nFor the first half of the tutorial, a simple two rule `<PolicySet>` will be administered using the **Authzforce** PAP. Thereafter the **Keyrock** GUI will be used to administer XACML rules within the existing tutorial application  on an individual XACML `<Rule>` level. The policy decision request code within the **PEP-Proxy** may also need to be customized to enable the enforcement of complex XACML rules.\n\n### Authzforce PAP\n\nWithin the **Authzforce** PAP all CRUD actions occur on the `<PolicySet>` level. It is therefore necessary to create a complete, valid XACML file before uploading it to the service. There is no GUI available to ensure the validity of the  `<PolicySet>` prior to uploading the XACML.\n\n### Keyrock PAP\n\n**Keyrock** can create a valid XACML file based on available roles and permissions and pass this to **Authzforce**. Indeed **Keyrock** already does this whenever it combines with **Authzforce** as all its own basic authorization (level 2) permissions must be translated into advanced authorization (level 3) permissions before they can be adjudicated by **Authzforce**.\n\nWithin **Keyrock**, each role corresponds to an XACML `<Policy>`, each permission within that role corresponds to an XACML `<Rule>`. There is a GUI available for uploading and amending the XACML for each `<Rule>` and all CRUD actions occur on the `<Rule>` level.\n\nProvided care is taken when creating `<Rule>` you can use **Keyrock** to simplify the administration of XACML and create a valid `<PolicySet>` for **Authzforce**.\n\n## PEP - Policy Execution Point\n\nWhen using advanced authorization (level 3),  a policy execution point sends the an authorization request to he relevant domain endpoint within **Authzforce**,\nproviding all of the information necessary for **Authzforce** to provide a\njudgement. Details of the interaction can be found in the [previous tutorial](https://github.com/Fiware/tutorials.XACML-Access-Rules).\n\nThe full code to supply each request to **Authzforce** can be found within the\ntutorials'\n[Git Repository](https://github.com/Fiware/tutorials.Step-by-Step/blob/master/context-provider/lib/azf.js)\n\nObviously the definition of _\"all of the information necessary\"_ may change\nover time, applications must therefore be flexible enough to be able to modify the requests sent to ensure that sufficient information is passed.\n\n# Prerequisites\n\n## Docker\n\nTo keep things simple all components will be run using\n[Docker](https://www.docker.com). **Docker** is a container technology which\nallows to different components isolated into their respective environments.\n\n-   To install Docker on Windows follow the instructions\n    [here](https://docs.docker.com/docker-for-windows/)\n-   To install Docker on Mac follow the instructions\n    [here](https://docs.docker.com/docker-for-mac/)\n-   To install Docker on Linux follow the instructions\n    [here](https://docs.docker.com/install/)\n\n**Docker Compose** is a tool for defining and running multi-container Docker\napplications. A\n[YAML file](https://raw.githubusercontent.com/Fiware/tutorials.Identity-Management/master/docker-compose.yml)\nis used configure the required services for the application. This means all\ncontainer services can be brought up in a single command. Docker Compose is\ninstalled by default as part of Docker for Windows and Docker for Mac, however\nLinux users will need to follow the instructions found\n[here](https://docs.docker.com/compose/install/)\n\n## Cygwin\n\nWe will start up our services using a simple bash script. Windows users should\ndownload [cygwin](http://www.cygwin.com/) to provide a command-line\nfunctionality similar to a Linux distribution on Windows.\n\n# Architecture\n\nThis application adds OAuth2-driven security into the existing Stock Management\nand Sensors-based application created in\n[previous tutorials](https://github.com/Fiware/tutorials.IoT-Agent/) by using\nthe data created in the first\n[security tutorial](https://github.com/Fiware/tutorials.Identity-Management/)\nand reading it programmatically. It will make use of three FIWARE components -\nthe [Orion Context Broker](https://fiware-orion.readthedocs.io/en/latest/),the\n[IoT Agent for UltraLight 2.0](https://fiware-iotagent-ul.readthedocs.io/en/latest/)\nand integrates the use of the\n[Keyrock](https://fiware-idm.readthedocs.io/en/latest/) Generic enabler. Usage\nof the Orion Context Broker is sufficient for an application to qualify as\n_“Powered by FIWARE”_.\n\nBoth the Orion Context Broker and the IoT Agent rely on open source\n[MongoDB](https://www.mongodb.com/) technology to keep persistence of the\ninformation they hold. We will also be using the dummy IoT devices created in\nthe [previous tutorial](https://github.com/Fiware/tutorials.IoT-Sensors/).\n**Keyrock** uses its own [MySQL](https://www.mysql.com/) database.\n\nTherefore the overall architecture will consist of the following elements:\n\n-   The FIWARE\n    [Orion Context Broker](https://fiware-orion.readthedocs.io/en/latest/) which\n    will receive requests using\n    [NGSI](https://fiware.github.io/specifications/OpenAPI/ngsiv2)\n-   The FIWARE\n    [IoT Agent for UltraLight 2.0](https://fiware-iotagent-ul.readthedocs.io/en/latest/)\n    which will receive southbound requests using\n    [NGSI](https://fiware.github.io/specifications/OpenAPI/ngsiv2) and convert\n    them to\n    [UltraLight 2.0](https://fiware-iotagent-ul.readthedocs.io/en/latest/usermanual/index.html#user-programmers-manual)\n    commands for the devices\n-   FIWARE [Keyrock](https://fiware-idm.readthedocs.io/en/latest/) offer a\n    complement Identity Management System including:\n    -   An OAuth2 authentication system for Applications and Users\n    -   A site graphical frontend for Identity Management Administration\n    -   An equivalent REST API for Identity Management via HTTP requests\n\n-   FIWARE [Authzforce](https://fiware-pep-proxy.rtfd.io/) is a XACML Server providing an interpretive Policy Decision Point (PDP)\n    access to the **Orion** and/or **IoT Agent** microservices\n-   FIWARE [Wilma](https://fiware-pep-proxy.rtfd.io/) is a PEP Proxy securing\n    access to the **Orion** microservices, it requests authorisation decisions from **Authzforce**\n-   The underlying [MongoDB](https://www.mongodb.com/) database :\n    -   Used by the **Orion Context Broker** to hold context data information\n        such as data entities, subscriptions and registrations\n    -   Used by the **IoT Agent** to hold device information such as device URLs\n        and Keys\n-   A [MySQL](https://www.mysql.com/) database :\n    -   Used to persist user identities, applications, roles and permissions\n-   The **Stock Management Frontend** does the following:\n    -   Displays store information\n    -   Shows which products can be bought at each store\n    -   Allows users to \"buy\" products and reduce the stock count.\n    -   Allows authorized users into restricted areas, it requests authoriation decisions from **Authzforce**\n-   A webserver acting as set of\n    [dummy IoT devices](https://github.com/Fiware/tutorials.IoT-Sensors) using\n    the\n    [UltraLight 2.0](https://fiware-iotagent-ul.readthedocs.io/en/latest/usermanual/index.html#user-programmers-manual)\n    protocol running over HTTP - access to certain resources is restricted.\n\nSince all interactions between the elements are initiated by HTTP requests, the\nentities can be containerized and run from exposed ports.\n\n![](https://fiware.github.io/tutorials.Administrating-XACML/img/architecture.png)\n\n\nThe all container configuration values described in the YAML file\nhave been described in previous tutorials\n\n\n\n# Start Up\n\nTo start the installation, do the following:\n\n```console\ngit clone git@github.com:Fiware/tutorials.Administrating-XACML.git\ncd tutorials.Administrating-XACML\n\n./services create\n```\n\n> **Note** The initial creation of Docker images can take up to three minutes\n\nThereafter, all services can be initialized from the command-line by running the\n[services](https://github.com/Fiware/tutorials.Administrating-XACML/blob/master/services)\nBash script provided within the repository:\n\n```console\n./services start\n```\n\n\n> **Note:** If you want to clean up and start over again\n> you can do so with the following command:\n>\n> ```\n> ./services stop\n> ```\n\n### Dramatis Personae\n\nThe following people at `test.com` legitimately have accounts within the\nApplication\n\n-   Alice, she will be the Administrator of the **Keyrock** Application\n-   Bob, the Regional Manager of the supermarket chain - he has several store\n    managers under him:\n    -   Manager1\n    -   Manager2\n-   Charlie, the Head of Security of the supermarket chain - he has several\n    store detectives under him:\n    -   Detective1\n    -   Detective2\n\n| Name       | eMail                     | Password |\n| ---------- | ------------------------- | -------- |\n| alice      | alice-the-admin@test.com  | `test`   |\n| bob        | bob-the-manager@test.com  | `test`   |\n| charlie    | charlie-security@test.com | `test`   |\n| manager1   | manager1@test.com         | `test`   |\n| manager2   | manager2@test.com         | `test`   |\n| detective1 | detective1@test.com       | `test`   |\n| detective2 | detective2@test.com       | `test`   |\n\nThe following people at `example.com` have signed up for accounts, but have no\nreason to be granted access\n\n-   Eve - Eve the Eavesdropper\n-   Mallory - Mallory the malicious attacker\n-   Rob - Rob the Robber\n\n| Name    | eMail               | Password |\n| ------- | ------------------- | -------- |\n| eve     | eve@example.com     | `test`   |\n| mallory | mallory@example.com | `test`   |\n| rob     | rob@example.com     | `test`   |\n\n\n# XACML Administration\n\nTo apply an access control policy, it is necessary to be able to do the following:\n\na) Create a consistent `<PolicySet>`\nb) Supply a Policy Execution Point (PEP) which provides necessary data\n\nAs will be seen, **Keyrock** is able help with the first point, and custom code within the **PEP Proxy** can help with the second. **Authzforce** itself does not offer a UI, and is not concerned with generation and management of XACML policies - it assumes that each `<PolicySet>` it receives has already been generated by another component.\n\nFull-blown XACML editors are available, but the limited editor within **Keyrock** is usually sufficient for most access control scenarios.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Authzforce PAP - Adminstrating XACML Policies",
			"item": [
				{
					"name": "Creating a new Domain",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/xml",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n<domainProperties xmlns=\"http://authzforce.github.io/rest-api-model/xmlns/authz/5\" externalId=\"airplane\"/>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains"
							]
						},
						"description": "To create a new domain in **Authzforce**, make a POST request to the\n`/authzforce-ce/domains` endpoint including a unique `external-id` within\nthe `<domainProperties>` element\n\nThe response includes a `href` in the `<n2:link>` element  which holds the\n`domain-id` used internally within **Authzforce**.\n\nAn empty `PolicySet` will be created for the new domain. By default all\naccess will be permitted."
					},
					"response": []
				},
				{
					"name": "Creating an initial PolicySet",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"type": "text",
								"value": "application/xml"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<PolicySet xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" PolicySetId=\"f8194af5-8a07-486a-9581-c1f05d05483c\" Version=\"9\" PolicyCombiningAlgId=\"urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-unless-permit\">\n   <Description>Policy Set for Airplane!</Description>\n   <Target />\n   <Policy PolicyId=\"airplane\" Version=\"1.0\" RuleCombiningAlgId=\"urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit\">\n      <Description>Vehicle Roles from the Male announcer in the movie Airplane!</Description>\n      <Target>\n         <AnyOf>\n            <AllOf>\n               <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                  <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">airplane!</AttributeValue>\n                  <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\" AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n               </Match>\n            </AllOf>\n         </AnyOf>\n      </Target>\n      <Rule RuleId=\"white-zone\" Effect=\"Permit\">\n         <Description>The white zone is for immediate loading and unloading of passengers only</Description>\n         <Target>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">white</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\" AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">loading</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\" AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n         </Target>\n         \n         \n         \n          <Condition>\n\n\n             <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:not\">\n                                 <Apply FunctionId=\"urn:oasis:names:tc:xacml:2.0:function:time-in-range\">\n                                    <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\">\n                                       <AttributeDesignator AttributeId=\"urn:oasis:names:tc:xacml:1.0:environment:current-time\" DataType=\"http://www.w3.org/2001/XMLSchema#time\" Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\" MustBePresent=\"false\"></AttributeDesignator>\n                                    </Apply>\n                                    <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\">\n                                       <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:time-bag\">\n                                          <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#time\">00:00:00-08:00</AttributeValue>\n                                       </Apply>\n                                    </Apply>\n                                    <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\">\n                                       <Apply FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:time-bag\">\n                                          <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#time\">18:00:00-23:59</AttributeValue>\n                                       </Apply>\n                                    </Apply>\n                                 </Apply>\n                              </Apply>\n                              \n                              \n               <!--Apply FunctionId=\"urn:oasis:names:tc:xacml:3.0:function:any-of\">\n                  <Function FunctionId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\" />\n                  <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">managers-role-0000-0000-000000000000</AttributeValue>\n                  <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\" AttributeId=\"urn:oasis:names:tc:xacml:2.0:subject:role\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"false\" />\n               </Apply-->\n         </Condition>\n         \n         \n         \n         \n         \n      </Rule>\n     \n   </Policy>\n</PolicySet>\n"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pap/policies",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pap",
								"policies"
							]
						},
						"description": "To create a `PolicySet` for a given domain information in **Authzforce**, make a\nPOST request to the\n`/authzforce-ce/domains/{{domain-id}}/pap/policies` endpoint including the full set\nof XACML rules to upload.\n\nFor this initial Policy, the following rules will be enforced\n\n* The **white** zone is for immediate loading and unloading of passengers only\n* There is no stopping in the **red** zone\n\nThe response contains the internal id of the policy held within **Authzforce** and \nversion information about the `PolicySet` versions available.\nThe rules of the new `PolicySet` will not be applied until the `PolicySet` is activated."
					},
					"response": []
				},
				{
					"name": "Activate the initial PolicySet",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"type": "text",
								"value": "application/xml"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><pdpPropertiesUpdate xmlns=\"http://authzforce.github.io/rest-api-model/xmlns/authz/5\"><rootPolicyRefExpression>f8194af5-8a07-486a-9581-c1f05d05483c</rootPolicyRefExpression></pdpPropertiesUpdate>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pap/pdp.properties",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pap",
								"pdp.properties"
							]
						},
						"description": "To activate a `PolicySet`, make a PUT request to the\n`/authzforce-ce/domains/{domain-id}/pap/pdp.properties` endpoint including the `policy-id`\nto update within the `<rootPolicyRefExpresion>` attribute\n\nThe response returns information about the `PolicySet` applied."
					},
					"response": []
				},
				{
					"name": "Updating a Policy Set",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"type": "text",
								"value": "application/xml"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<PolicySet xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" PolicySetId=\"f8194af5-8a07-486a-9581-c1f05d05483c\" Version=\"2\" PolicyCombiningAlgId=\"urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-unless-permit\">\n   <Description>Policy Set for Airplane!</Description>\n   <Target />\n   <Policy PolicyId=\"airplane\" Version=\"1.0\" RuleCombiningAlgId=\"urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit\">\n      <Description>Vehicle Roles from the Female announcer in the movie Airplane!</Description>\n      <Target>\n         <AnyOf>\n            <AllOf>\n               <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                  <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">airplane!</AttributeValue>\n                  <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\" AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n               </Match>\n            </AllOf>\n         </AnyOf>\n      </Target>\n      <Rule RuleId=\"red-zone\" Effect=\"Permit\">\n         <Description>The red zone is for immediate loading and unloading of passengers only</Description>\n         <Target>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">red</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\" AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">loading</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\" AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n         </Target>\n      </Rule>\n      <Rule RuleId=\"white-zone\" Effect=\"Deny\">\n         <Description>There is no stopping in the white zone</Description>\n         <Target>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">white</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\" AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n            <AnyOf>\n               <AllOf>\n                  <Match MatchId=\"urn:oasis:names:tc:xacml:1.0:function:string-equal\">\n                     <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">stopping</AttributeValue>\n                     <AttributeDesignator Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\" AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" DataType=\"http://www.w3.org/2001/XMLSchema#string\" MustBePresent=\"true\" />\n                  </Match>\n               </AllOf>\n            </AnyOf>\n         </Target>\n      </Rule>\n   </Policy>\n</PolicySet>\n"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pap/policies",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pap",
								"policies"
							]
						},
						"description": "To update a `PolicySet` for a given domain information in **Authzforce**, make a\nPOST request to the\n`/authzforce-ce/domains/{{domain-id}}/pap/policies` endpoint including the full set\nof XACML rules to upload. Note that the `Version` must be unique.\n\nFor the updated Policy, the previous rules will be reversed\n\n* The **red** zone is for immediate loading and unloading of passengers only\n* There is no stopping in the **white** zone\n\nThe response contains version information about the `PolicySet` versions available.\nThe rules of the new `PolicySet` will not be applied until the `PolicySet` is activated."
					},
					"response": []
				},
				{
					"name": "Activating an updated PolicySet",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"type": "text",
								"value": "application/xml"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><pdpPropertiesUpdate xmlns=\"http://authzforce.github.io/rest-api-model/xmlns/authz/5\"><rootPolicyRefExpression>f8194af5-8a07-486a-9581-c1f05d05483c</rootPolicyRefExpression></pdpPropertiesUpdate>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pap/pdp.properties",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pap",
								"pdp.properties"
							]
						},
						"description": "To update an active a `PolicySet`, make another PUT request to the\n`/authzforce-ce/domains/{domain-id}/pap/pdp.properties` endpoint including the `policy-id`\nto update within the `<rootPolicyRefExpresion>` attribute. The ruleset will be updated to\napply the latest uploaded version.\n\nThe response returns information about the `PolicySet` applied."
					},
					"response": []
				}
			],
			"description": "**Authzforce** can act as a Policy Administration Point (PAP), this means that PolicySets can be created and amended using API calls directly to **Authzforce**\n\nHowever there is no GUI for creating or amending a `<PolicySet>`, and no generation tool. All CRUD actions occur on the `<PolicySet>` level.",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "6bba1d42-8a2c-4d85-b103-5792ce90530f",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "64d519de-39c8-47bb-8e9e-00b2e3aff3ce",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "Authzforce PDP - Requesting Policy Decisions",
			"item": [
				{
					"name": "White Zone Permissions",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/xml",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Request xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" CombinedDecision=\"false\" ReturnPolicyIdList=\"false\">\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\">\n      <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">airplane!</AttributeValue>\n      </Attribute>\n      <Attribute AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">white</AttributeValue>\n      </Attribute>\n   </Attributes>\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\">\n      <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">loading</AttributeValue>\n      </Attribute>\n   </Attributes>\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\" />\n</Request>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pdp",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pdp"
							]
						},
						"description": "To request a decision from Authzforce, make a POST request to the\n`domains/{domain-id}/pdp` endpoint. In this case the user has the\nis requesting access to `loading` in the `white` zone.\n\nThe response for the request includes a `<Decision>` element to `Permit` or `Deny` access to the resource."
					},
					"response": []
				},
				{
					"name": "Red Zone Permissions",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/xml",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Request xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" CombinedDecision=\"false\" ReturnPolicyIdList=\"false\">\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\">\n      <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">airplane!</AttributeValue>\n      </Attribute>\n      <Attribute AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">red</AttributeValue>\n      </Attribute>\n   </Attributes>\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\">\n      <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" IncludeInResult=\"false\">\n         <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">loading</AttributeValue>\n      </Attribute>\n   </Attributes>\n   <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\" />\n</Request>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{new-domain-id}}/pdp",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{new-domain-id}}",
								"pdp"
							]
						},
						"description": "To request a decision from Authzforce, make a POST request to the\n`domains/{domain-id}/pdp` endpoint. In this case the user has the\nis requesting access to `loading` in the `red` zone.\n\nThe response for the request includes a `<Decision>` element to `Permit` or `Deny` access to the resource."
					},
					"response": []
				}
			],
			"description": "At several points within this tutorial, a Policy Decision can be requested using **Authzforce**.\n\nThe simple `<PolicySet>` used consists of two rules:\n\n* The **red** zone is for immediate loading and unloading of passengers only\n* There is no stopping in the **white** zone\n\nThe updated policy switches the zones used. \n\n\nTo request a decision from Authzforce, a structured request containing all\nrelevant information must be sent to the `domains/{domain-id}/pdp` endpoint. In\nthis case, the Body of the request must include sufficient information so that\nthe access request can be adjudicated.",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "7b40d496-0a0f-424d-a300-d7a4c7946cf7",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "121f1a38-45b2-4245-9fdc-97dfd34c1f5b",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "Keyrock PAP - Administrating XACML Permissions",
			"item": [
				{
					"name": "Create token with Password",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"alice-the-admin@test.com\",\n  \"password\": \"test\"\n}"
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/auth/tokens",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"auth",
								"tokens"
							]
						},
						"description": "Enter a username and password to enter the application. The default super-user has the values `alice-the-admin@test.com` and `test`.\n\nThe response header returns an `X-Subject-token` which identifies who has logged on the application.\nThis token is required in all subsequent requests to gain access"
					},
					"response": []
				},
				{
					"name": "Read a Verb-Resource Permission",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json",
								"disabled": true
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Auth-token",
								"value": "{{X-Auth-token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": ""
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/applications/{{app-id}}/permissions/entrance-open-0000-0000-000000000000",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"applications",
								"{{app-id}}",
								"permissions",
								"entrance-open-0000-0000-000000000000"
							]
						},
						"description": "The `/applications/{{app-id}}/permissions/{permission-id}}` endpoint will return the permission\nlisted under that id. The `X-Auth-token` must be supplied in the headers.\n\nThe response returns the details of the requested permission, for a verb-resource permission, the `xml` element is `null`. This permission indicates that a user is permittted to make a POST request\nto the `/door/unlock` endpoint to unlock the main entrance."
					},
					"response": []
				},
				{
					"name": "Read an XACML Rule Permission",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json",
								"disabled": true
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Auth-token",
								"value": "{{X-Auth-token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": ""
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/applications/{{app-id}}/permissions/alrmbell-ring-24hr-xaml-000000000000",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"applications",
								"{{app-id}}",
								"permissions",
								"alrmbell-ring-24hr-xaml-000000000000"
							]
						},
						"description": "The `/applications/{{app-id}}/permissions/{permission-id}}` endpoint will return the permission\nlisted under that id. The `X-Auth-token` must be supplied in the headers.\n\nThe response returns the details of the requested permission, for a XACML Rule permission, the `xml` element holds the details of the associated XACML `<Rule>`\nthe `action` and `resource` fields are  `null`."
					},
					"response": []
				},
				{
					"name": "Update an XACML Permission",
					"request": {
						"method": "PATCH",
						"header": [
							{
								"key": "Accept",
								"value": "application/json",
								"disabled": true
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Auth-token",
								"value": "{{X-Auth-token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n\t\"permission\": {\n        \"action\": \"\",\n        \"resource\": \"\",\n        \"xml\": \"<Rule RuleId=\\\"alrmbell-ring-only-000000000000\\\" Effect=\\\"Permit\\\">\\n<Description>Allow Full Access to Charlie the Security Manager</Description>\\n<Target>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">/bell/ring</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\\\" AttributeId=\\\"urn:thales:xacml:2.0:resource:sub-resource-id\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">POST</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\\\" AttributeId=\\\"urn:oasis:names:tc:xacml:1.0:action:action-id\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">charlie</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\\\" AttributeId=\\\"urn:oasis:names:tc:xacml:1.0:subject:subject-id\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n</Target>\\n</Rule>\\n<Rule RuleId=\\\"alrmbell-ring-24hr-hours-000000000000\\\" Effect=\\\"Permit\\\">\\n<Description>Ring Alarm Bell (Outside Core Hours)</Description>\\n<Target>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">/bell/ring</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\\\" AttributeId=\\\"urn:thales:xacml:2.0:resource:sub-resource-id\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">POST</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\\\" AttributeId=\\\"urn:oasis:names:tc:xacml:1.0:action:action-id\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n<AnyOf>\\n<AllOf>\\n<Match MatchId=\\\"urn:oasis:names:tc:xacml:1.0:function:string-equal\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\">security-role-0000-0000-000000000000</AttributeValue>\\n<AttributeDesignator Category=\\\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\\\" AttributeId=\\\"urn:oasis:names:tc:xacml:2.0:subject:role\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#string\\\" MustBePresent=\\\"true\\\" />\\n</Match>\\n</AllOf>\\n</AnyOf>\\n</Target>\\n<Condition>\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:not\\\">\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:2.0:function:time-in-range\\\">\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\\\">\\n<AttributeDesignator AttributeId=\\\"urn:oasis:names:tc:xacml:1.0:environment:current-time\\\" DataType=\\\"http://www.w3.org/2001/XMLSchema#time\\\" Category=\\\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\\\" MustBePresent=\\\"false\\\"></AttributeDesignator>\\n</Apply>\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\\\">\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:time-bag\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#time\\\">08:00:00</AttributeValue>\\n</Apply>\\n</Apply>\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:time-one-and-only\\\">\\n<Apply FunctionId=\\\"urn:oasis:names:tc:xacml:1.0:function:time-bag\\\">\\n<AttributeValue DataType=\\\"http://www.w3.org/2001/XMLSchema#time\\\">17:00:00</AttributeValue>\\n</Apply>\\n</Apply>\\n</Apply>\\n</Apply>\\n</Condition>\\n</Rule>\"\n\t}\n}"
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/applications/{{app-id}}/permissions/alrmbell-ring-24hr-xaml-000000000000",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"applications",
								"{{app-id}}",
								"permissions",
								"alrmbell-ring-24hr-xaml-000000000000"
							]
						},
						"description": "This is most easily be done in the GUI by pasting the rule into the appropriate\ntext box, however it can also be done programmatically.\n\nTo log-in to the **Keyrock** GUI, enter the username and password on the log-in\npage `http://localhost:3005/`\n\n![](https://fiware.github.io/tutorials.Administrating-XACML/img/login.png)\n\nNavigate to correct application, and click on the manage roles tab\n\n![](https://fiware.github.io/tutorials.Administrating-XACML/img/manage-roles.png)\n\nSelect a permission to edit\n\n![](https://fiware.github.io/tutorials.Administrating-XACML/img/edit-permission.png)\n\nThe HTTP Verb and Resource rule needs to be left blank, but the applicable XACML\n`<Rule>` elements need to be pasted within the **Advanced XACML Rule** textbox\nas shown:\n\n![](https://fiware.github.io/tutorials.Administrating-XACML/img/permission.png)\n\nTo amend the XACML rules governing a permission, make a PATCH request to the  `/applications/{{app-id}}/permissions/{permission-id}}` endpoint. The body of the request must include three attributes - `action` and `resource` must both be set to `\"\"` and the `xml` attribute should hold the XACML text.\n\n\nThe response shows the details of the attributes which have been updated."
					},
					"response": []
				},
				{
					"name": "Delete Role-Permission Association",
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Accept",
								"value": "application/json",
								"disabled": true
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Auth-token",
								"value": "{{X-Auth-token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": ""
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/applications/{{app-id}}/roles/{{role-id}}/permissions/alrmbell-ring-24hr-xaml-000000000000",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"applications",
								"{{app-id}}",
								"roles",
								"{{role-id}}",
								"permissions",
								"alrmbell-ring-24hr-xaml-000000000000"
							]
						}
					},
					"response": []
				},
				{
					"name": "Create a Role-Permission Association",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json",
								"disabled": true
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Auth-token",
								"value": "{{X-Auth-token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": ""
						},
						"url": {
							"raw": "http://{{keyrock}}/v1/applications/{{app-id}}/roles/{{role-id}}/permissions/alrmbell-ring-24hr-xaml-000000000000",
							"protocol": "http",
							"host": [
								"{{keyrock}}"
							],
							"path": [
								"v1",
								"applications",
								"{{app-id}}",
								"roles",
								"{{role-id}}",
								"permissions",
								"alrmbell-ring-24hr-xaml-000000000000"
							]
						}
					},
					"response": []
				}
			],
			"description": "**Keyrock** offers a role based access control identity management system. Typically every permission is only accessible to  users within a given role. We have already seen how Verb-Resource rules can be [set-up](https://github.com/Fiware/tutorials.Roles-Permissions/) and [enforced](https://github.com/Fiware/tutorials.Securing-Access/) using the basic authorization (level 2) access control mechanism found within Keyrock, the data for defining an advanced permission can also be administed using the **Keyrock** GUI or via **Keyrock** REST API requests.\n\n**Keyrock** permissions work on individual XACML `<Rule>` elements rather than a complete `<PolicySet>`. The `<PolicySet>` is generated by combining all the roles and permissions.\n\n### Predefined Roles and Permissions\n\nIn a similar manner to the previous tutorial, two roles have been created, one\nfor store detectives and another for management users. A series of permissions have been set up for the supermarket application, the following XACML rules are applied:\n\n#### Security Staff\n\n* Can unlock the door at any time\n* Can ring the alarm bell before 9 a.m. or after 5 p.m.\n* Can access the **context broker** data at any time\n\n\n#### Mangement\n\n* Have access to the price change area\n* Have access to the stock count area\n* Can ring the alarm bell between 9 a.m. and 5 p.m.\n* Can access the **context broker** data from 9 a.m. to 5 p.m.\n\nAs you can see some of the new rules now have a time element to them and are no longer simple Verb-Resource rules.\n\nFor most of the\nrules, the Policy Execution Point (i.e. the request to **Authzforce** and analysis of the result)  is found within the tutorial [code](https://github.com/Fiware/tutorials.Step-by-Step/blob/master/context-provider/lib/azf.js) -\n\nThe **context broker** data for the **Store** and **IoT Devices** is held in is secured behind the **PEP Proxy**. This means that only security staff are able to access the system outside of core hours.\n\n> **Note** within the **Keyrock**, only four resources have been secured using advanced authorization rules (level 3)\n>\n> -   sending the ring bell command\n> -   access to the price-change area\n> -   access to the order-stock area\n> -   PEP Proxy access to the **context broker**\n>\n> For contrast, one resource has been left as a simple VERB Resource permission (level 2)\n>\n> -   sending the unlock door command",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "7b40d496-0a0f-424d-a300-d7a4c7946cf7",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "121f1a38-45b2-4245-9fdc-97dfd34c1f5b",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "Authzforce PDP - Requesting Policy Decisions",
			"item": [
				{
					"name": "Deny Access to a Resource",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/xml",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Request xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" CombinedDecision=\"false\" ReturnPolicyIdList=\"false\">\n  <Attributes Category=\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:2.0:subject:role\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">security-role-0000-0000-000000000000</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">tutorial-dckr-site-0000-xpresswebapp</AttributeValue>\n     </Attribute>\n     <Attribute AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">/bell/ring</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">POST</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\" />\n</Request>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{domain-id}}/pdp",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{domain-id}}",
								"pdp"
							]
						},
						"description": "To request a decision from Authzforce, make a POST request to the\n`domains/{domain-id}/pdp` endpoint. In this case the user has the\nis requesting access to `POST` to the `/ring/bell` endpoint.\n\nThe response for the request includes a `<Decision>` element to `Permit` or `Deny` access to the resource.\n\nIf the time on the server is between 9 a.m. and 5 p.m. the access request will be denied."
					},
					"response": []
				},
				{
					"name": "Permit Access to a Resource",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/xml",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Request xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" CombinedDecision=\"false\" ReturnPolicyIdList=\"false\">\n  <Attributes Category=\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:subject:subject-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">charlie</AttributeValue>\n     </Attribute>\n     <Attribute AttributeId=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">charlie-security@test.com</AttributeValue>\n     </Attribute>\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:2.0:subject:role\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">security-role-0000-0000-000000000000</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:resource:resource-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">tutorial-dckr-site-0000-xpresswebapp</AttributeValue>\n     </Attribute>\n     <Attribute AttributeId=\"urn:thales:xacml:2.0:resource:sub-resource-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">/bell/ring</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:action\">\n     <Attribute AttributeId=\"urn:oasis:names:tc:xacml:1.0:action:action-id\" IncludeInResult=\"false\">\n        <AttributeValue DataType=\"http://www.w3.org/2001/XMLSchema#string\">POST</AttributeValue>\n     </Attribute>\n  </Attributes>\n  <Attributes Category=\"urn:oasis:names:tc:xacml:3.0:attribute-category:environment\" />\n</Request>"
						},
						"url": {
							"raw": "http://{{authzforce}}/authzforce-ce/domains/{{domain-id}}/pdp",
							"protocol": "http",
							"host": [
								"{{authzforce}}"
							],
							"path": [
								"authzforce-ce",
								"domains",
								"{{domain-id}}",
								"pdp"
							]
						},
						"description": "Additional Fields can be added to the policy decision request to improve the likelyhood of a `Permit` response.\n\nIn the example below, the `emailaddress` and `subject:subject-id` have been added to the body of the request\nwithin the `subject-category:access-subject` category.\n\nWith the new rule in place, the user `charlie` will be able to access the `/bell/ring` endpoint at all times of day."
					},
					"response": []
				}
			],
			"description": "To request a decision from Authzforce, a structured request containing all\nrelevant information must be sent to the `domains/{domain-id}/pdp` endpoint. In\nthis case, the Body of the request includes information such as the roles that\nthe User has, the application id that is being requested\n(`tutorial-dckr-site-0000-xpresswebapp`) and the HTTP verb and resource that are\nbeing requested ( a GET request on the `/app/price-change` URL). Obviously the\ninformation passed in the Body can be expanded as the rules become more complex.",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "7b40d496-0a0f-424d-a300-d7a4c7946cf7",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "121f1a38-45b2-4245-9fdc-97dfd34c1f5b",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "Tutorial PEP - Extending Advanced Authorization",
			"item": [],
			"description": "The new policy for Charlie the security manager needs additional information to\nbe passed to **Authzforce**\n\n### Extending Advanced Authorization - Sample Code\n\nProgrammatically, any Policy Execution Point consists of two parts, an OAuth\nrequest to Keyrock retrieves information about the user (such as the assigned\nroles) as well as the policy domain to be queried.\n\nA second request is sent to the relevant domain endpoint within Authzforce,\nproviding all of the information necessary for Authzforce to provide a\njudgement. Authzforce responds with a **permit** or **deny** response, and the\ndecision whether to continue can be made thereafter.\n\nThe `user.username` and `user.email` have been added to the list of fields\nto be sent to **Authzforce**\n\n```javascript\nfunction authorizeAdvancedXACML(req, res, next, resource = req.url) {\n    const keyrockUserUrl =\n        \"http://keyrock/user?access_token=\" +\n        req.session.access_token +\n        \"&app_id=\" +\n        clientId +\n        \"&authzforce=true\";\n\n    return oa\n        .get(keyrockUserUrl)\n        .then(response => {\n            const user = JSON.parse(response);\n            return azf.policyDomainRequest(\n                user.app_azf_domain,\n                user.roles,\n                user.username,\n                user.email,\n                resource,\n                req.method\n            );\n        })\n        .then(authzforceResponse => {\n            res.locals.authorized = authzforceResponse === \"Permit\";\n            return next();\n        })\n        .catch(error => {\n            debug(error);\n            res.locals.authorized = false;\n            return next();\n        });\n}\n```\n\nThe full code to supply each request to Authzforce can be found within the\ntutorials'\n[Git Repository](https://github.com/Fiware/tutorials.Step-by-Step/blob/master/context-provider/lib/azf.js) -\nthe supplied information has been expanded to include the `username` and `email` within the generated XACML request\n\n```javascript\nconst xml2js = require(\"xml2js\");\nconst request = require(\"request\");\n\nfunction policyDomainRequest(domain, roles, resource, action, username, email ) {\n    let body =\n        '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n' +\n        '<Request xmlns=\"urn:oasis:names:tc:xacml:3.0:core:schema:wd-17\" CombinedDecision=\"false\" ReturnPolicyIdList=\"false\">\\n';\n    // Code to create the XML body for the request is omitted\n    body = body + \"</Request>\";\n\n    const options = {\n        method: \"POST\",\n        url: \"http://authzforceUrl/authzforce-ce/domains/\" + domain + \"/pdp\",\n        headers: { \"Content-Type\": \"application/xml\" },\n        body\n    };\n\n    return new Promise((resolve, reject) => {\n        request(options, function(error, response, body) {\n            let decision;\n            xml2js.parseString(\n                body,\n                { tagNameProcessors: [xml2js.processors.stripPrefix] },\n                function(err, jsonRes) {\n                    // The decision is found within the /Response/Result[0]/Decision[0] XPath\n                    decision = jsonRes.Response.Result[0].Decision[0];\n                }\n            );\n            decision = String(decision);\n            return error ? reject(error) : resolve(decision);\n        });\n    });\n}\n```\n\n\n\n## Extending Advanced Authorization - Running the Example\n\nAfter successfully update the **Authzforce** `<PolicySet>` to include a special rule for Charlie, his rights will differ from other users in the security role\n\n#### Detective 1\n\nDetective1 works for Charlie and has the **security** role\n\n-   From `http://localhost:3000`, log in as `detective1@test.com` with the\n    password `test`\n\n##### Level 3: Advanced Authorization Access\n\n-   Click on the restricted access links at `http://localhost:3000` - access is\n    **denied** - This is a management only permission\n-   Open the Device Monitor on `http://localhost:3000/device/monitor`\n    -   Unlock a door - access is **permitted** - This is a security only\n        permission\n    -   Ring a bell - access is **denied** - This is not permitted to security\n        users between 9 a.m. and 5 p.m.\n\n#### Charlie the Security Manager\n\nCharlie has the **security** role\n\n-   From `http://localhost:3000`, log in as `charlie-security@test.com` with the\n    password `test`\n\n##### Level 3: Advanced Authorization Access\n\n-   Click on the restricted access links at `http://localhost:3000` - access is\n    **denied** - This is a management only permission\n-   Open the Device Monitor on `http://localhost:3000/device/monitor`\n    -   Unlock a door - access is **permitted** - This is a security only\n        permission\n    -   Ring a bell - access is **permitted** - This is an exception which is only permitted to the user called `charlie`"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "bf821021-7bc2-471e-9ab7-a55ecb9e663f",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "1269e342-1093-4844-83cb-f8fed192c512",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"id": "27142bca-d545-4097-a67c-983e9159366a",
			"key": "authzforce",
			"value": "localhost:8080",
			"type": "string"
		},
		{
			"id": "773732a3-83c3-4517-a959-378beb9f5f7f",
			"key": "keyrock",
			"value": "localhost:3005",
			"type": "string"
		},
		{
			"id": "04777bc5-5942-4727-bc30-5a634d050cbe",
			"key": "domain-id",
			"value": "gQqnLOnIEeiBFQJCrBIBDA",
			"type": "string"
		},
		{
			"id": "3b1f9f18-ef6f-4295-8c5c-96a593d8d04c",
			"key": "policy-id",
			"value": "f8194af5-8a07-486a-9581-c1f05d05483c",
			"type": "string"
		},
		{
			"id": "80d528bf-ecef-417a-90f3-64bf6035fb51",
			"key": "app-id",
			"value": "tutorial-dckr-site-0000-xpresswebapp",
			"type": "string"
		},
		{
			"id": "bff37774-d3ea-48da-bbfc-e0e1556e3089",
			"key": "new-domain-id",
			"value": "czGVrRJvEemHrAJCrBIBDA",
			"type": "string"
		},
		{
			"id": "7de0f3db-769d-4a61-a1c9-f19b9f97a72f",
			"key": "X-Auth-token",
			"value": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
			"type": "string"
		},
		{
			"id": "9d2d152b-cc60-41d2-bcad-357fe734b574",
			"key": "X-Subject-token",
			"value": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
			"type": "string"
		},
		{
			"id": "63e567ad-0fd4-44bc-8738-f993786543a3",
			"key": "role-id",
			"value": "security-role-0000-0000-000000000000",
			"type": "string"
		}
	]
}